---
name: x-task-replanner
description: Updates ALL task types (impl/refactoring/test). Compares IDEAL vs existing, categorizes operations (KEEP/UPDATE/OBSOLETE/CREATE), executes changes in Linear.
---

# Universal Task Replanner

**Universal replanner** worker skill for updating ALL 3 task types in Linear when requirements change. Invoked by orchestrators when existing tasks found (REPLAN MODE).

## Overview

### What This Skill Does

**Replans tasks for ALL 3 types** when requirements change:
- **Implementation tasks** (from x-task-coordinator): Feature development tasks when Story AC/Technical Approach changed
- **Refactoring tasks** (from x-story-quality-coordinator): Code quality improvement tasks when new issues found
- **Test tasks** (from x-test-coordinator): E2E/Integration/Unit test tasks when manual test results changed

**Workflow:**
- Receives IDEAL task plan from orchestrator (1-6 tasks for implementation, 1-3 issues for refactoring, test plan for test tasks)
- Loads existing tasks from Linear (full descriptions, 7 sections for impl/refactoring OR 11 sections for test)
- Compares IDEAL plan vs existing tasks using replan algorithm
- Categorizes operations: KEEP (unchanged), UPDATE (AC/approach changed), OBSOLETE (feature removed), CREATE (new requirement)
- Shows operations summary with diffs
- Executes all operations in Linear (update descriptions, cancel obsolete, create new)
- Updates kanban_board.md (remove canceled, add new tasks)

### When This Skill Is Invoked

**Automatically invoked by 3 orchestrators** when:

**1. x-task-coordinator (REPLAN MODE):**
- Story has existing implementation tasks (Linear count ≥ 1)
- IDEAL plan generated by orchestrator (Phase 2: Analyze & Decompose)
- User confirmed replan execution

**2. x-story-quality-coordinator (Phase 6 Path B - Issues Found):**
- Existing refactoring task found (from previous review)
- New code quality issues detected
- Refactoring plan changed

**3. x-test-coordinator (Phase 6 - Manual Testing Changed):**
- Existing test task found (from previous finalization)
- Manual test results changed (new scenarios, different Priority values)
- Test plan changed

**Never invoked directly by users** - always through orchestrators.

### Input from Orchestrator

**Common parameters** (all orchestrators provide):
- **taskType**: `"implementation"` | `"refactoring"` | `"test"` (REQUIRED)
- **Team ID**: Linear team identifier
- **Story Data**: Story ID, title, description (AC, Technical Notes, Context)
- **Existing Task IDs**: List of Linear issue IDs for this Story

**Type-specific parameters:**

**For implementation (from x-task-coordinator):**
- **IDEAL Plan**: Array of 1-6 task specifications
- **Guide Links**: Extracted from Story Technical Notes "Related Guides:"

**For refactoring (from x-story-quality-coordinator):**
- **Code Quality Issues**: Array of DRY/KISS/YAGNI/Architecture violations
- **Refactoring Plan**: Step-by-step fix plan (3 phases)
- **Affected Components**: Files impacted by refactoring

**For test (from x-test-coordinator):**
- **Manual Test Results**: Structured comment (Format v1.0) with AC, scenarios, edge cases
- **Test Plan**: E2E (2-5), Integration (0-8), Unit (0-15) tests with Priority ≥15
- **Infrastructure Changes**, **Documentation Updates**, **Legacy Cleanup**

---

## Workflow

### Phase 1: Load Existing Tasks

**Goal**: Fetch full task descriptions from Linear for comparison, determine task type.

**Step 1: Determine Task Type from Templates**

Read template from x-task-creator/references/ based on `taskType` parameter:
- `taskType: "implementation"` → Template: `task_template_implementation.md` (7 sections)
- `taskType: "refactoring"` → Template: `refactoring_task_template.md` (7 sections)
- `taskType: "test"` → Template: `test_task_template.md` (11 sections)

**Step 2: Query Linear**

For EACH existing task ID:
```
mcp__linear-server__get_issue(id=task_id)
```

**Step 3: Parse Sections Based on Task Type**

**For implementation tasks (7 sections):**
- Context (Current/Desired state)
- Implementation Plan (3 phases, checkboxes)
- Technical Approach (library, APIs, pseudocode, guide links)
- Acceptance Criteria (Given-When-Then scenarios)
- Affected Components (Implementation + Documentation files)
- Existing Code Impact (Refactoring, Tests to update, Docs to update)
- Definition of Done (completion checklist)

**For refactoring tasks (7 sections):**
- Context (Problems Found during review)
- Code Quality Issues (Issue 1-3 with Category/Severity/Before/After)
- Refactoring Goal (Fix all issues, preserve functionality)
- Refactoring Plan (3 phases: Analysis → Execution → Verification)
- Regression Testing Strategy (Baseline → Verify → Failure Handling)
- Code Simplification Principles (5 principles)
- Acceptance Criteria (All tests pass + DRY/KISS/YAGNI checks)

**For test tasks (11 sections):**
- Context (Story Goal + Implemented Features)
- Risk Priority Matrix (Business Impact × Probability)
- E2E Tests (2-5 max, Priority ≥15)
- Integration Tests (0-8 max, Priority ≥15)
- Unit Tests (0-15 max, Priority ≥15)
- Critical Path Coverage (verify all Priority ≥15)
- Definition of Done (test checklist)
- Existing Tests to Fix/Update (Section 8)
- Infrastructure Changes (Section 9)
- Documentation Updates (Section 10)
- Legacy Code Cleanup (Section 11)

**Step 4: Extract Metadata**

- Task ID, title, status (Todo/In Progress/To Review/Done/Canceled)
- AC scenarios referenced (for impl/test) OR Issues (for refactoring)
- Goal (from title and Context section)
- Estimate (from title or Implementation Plan)
- Guide links (from Technical Approach for impl, Refactoring Plan for refactoring)

**Step 5: Result**

Array of existing task structures ready for comparison.

### Phase 2: Compare IDEAL vs Existing

**Goal**: Categorize operations for each task using replan algorithm.

**Algorithm**: See [replan_algorithm.md](references/replan_algorithm.md) for detailed comparison logic.

**Steps**:

#### Step 1: Match by Goal

For EACH task in IDEAL plan:
- Extract goal (from title and description)
- Search existing tasks for similar goal:
  - Fuzzy match on titles (e.g., "token generation" matches "Implement token generation endpoint")
  - Check AC overlap (do they cover same Story AC?)
  - Look for key terms
- Result: Match found → Candidate for KEEP/UPDATE, No match → Mark for CREATE

For EACH existing task:
- Extract goal (from title and AC)
- Search IDEAL plan for similar goal
- Result: Match found → Candidate for KEEP/UPDATE, No match → Mark for OBSOLETE

#### Step 2: Determine Operations

**Categorize each task based on criteria:**

| Operation | Criteria | Status Constraints | Action |
|-----------|----------|-------------------|--------|
| **KEEP** | Goal match + AC unchanged + Approach valid + Components same (ALL true) | Any | None |
| **UPDATE** | Goal match + (AC changed OR Approach changed OR Components changed) (ANY true) | Todo/Backlog ✅<br>In Progress/Review ⚠️<br>Done ❌ | `update_issue(description)` |
| **OBSOLETE** | No goal match + Feature removed (ALL true) | Todo/Backlog ✅<br>In Progress/Review ⚠️<br>Done ❌ | `update_issue(state="Canceled")` + comment |
| **CREATE** | In IDEAL + No existing match + New requirement (ALL true) | N/A | Generate doc + `create_issue()` |

**Details:** See [replan_algorithm.md](references/replan_algorithm.md) for detailed criteria and edge cases.

#### Step 3: Handle Edge Cases

**Show WARNING, let user decide (no auto-action):**

| Case | Condition | Action |
|------|-----------|--------|
| **In Progress OBSOLETE** | Task not in IDEAL + status In Progress/Review | NO auto-cancel, show ⚠️ |
| **Done conflicts** | IDEAL differs from Done tasks | Preserve Done, CREATE follow-up |
| **Multiple matches** | >1 existing task matches IDEAL goal | Show all, user consolidates |
| **AC reassignment** | AC moved between tasks | Show warning, create refactoring task |

**Details:** [replan_algorithm.md](references/replan_algorithm.md)

### Phase 3: Show Operations Summary

Display replan summary with diffs:

```
REPLAN SUMMARY for [Story ID: Story Title]:

IDEAL PLAN (from Story analysis):
1. [Task 1 title] (AC#, AC#)
2. [Task 2 title] (AC#, AC#) ← AC# ADDED!
3. [Task 3 title] (NEW AC#) ← NEW!

EXISTING TASKS:

✓ [TASK_ID: Task Title]
   Status: Done
   Operation: KEEP (matches plan, already Done)

⚠ [TASK_ID: Task Title]
   Status: Todo
   Operation: UPDATE (AC changed)
   Changes:
     - Add AC#: [scenario description]
     - Update Implementation Plan with [details]
     - Update Technical Approach: [guide link added]

   Diff:
   [Show before/after diff for changed sections]

✗ [TASK_ID: Task Title]
   Status: Todo
   Operation: OBSOLETE (feature removed from Story)
   Action: Cancel task (state="Canceled")

NEW TASKS:

+ [New task title] (NEW AC#)
   Goal: [description]
   Estimate: X hours
   AC: [scenarios]

OPERATIONS: X keep, X update, X cancel, X create

WARNINGS:
- [Warning 1: Task in progress affected]
- [Warning 2: AC reassignment detected]

Type "confirm" to execute all operations.
```

**Diff Format for UPDATE operations**:
```diff
## Acceptance Criteria

- **Given** [context] **When** [action] **Then** [result]

+ **Given** [new context] **When** [new action] **Then** [new result]
```

### Phase 4: User Confirmation

**Check invocation context:**

**If invoked by orchestrator with `autoApprove: true` parameter:**
- ✅ **Skip user confirmation** → Proceed directly to Phase 5
- Rationale: Full pipeline automation mode (x-story-processor)

**If invoked by user directly OR autoApprove not provided:**
- Wait for user input:
  - **"confirm"** → Continue to Phase 5
  - **Any other input** → Abort, return to orchestrator

### Phase 5: Execute Operations

**Workflow:** UPDATE → OBSOLETE → CREATE → Update kanban_board.md (sequential)

**For UPDATE operations:**
Generate new doc (taskType determines template) → Validate (same rules as x-task-creator Phase 2) → `update_issue(description)` → Add comment

**For OBSOLETE operations:**
`update_issue(state="Canceled")` → Add comment (AC numbers + reason)

**For CREATE operations:**
Generate doc → Validate → `create_issue(parentId=Story.id, state="Backlog")` → Capture URL

**Validation rules (type-specific, same as x-task-creator Phase 2):**

| Task Type | HARD RULE | Validation | Error Action |
|-----------|-----------|------------|--------------|
| implementation | NO test creation | Scan: "write tests", "create tests", "add tests" | Stop execution |
| refactoring | Regression Strategy REQUIRED | Verify: Code Quality Issues, 3-phase Plan, "Preserve Functionality" | Stop execution |
| test | Risk-Based (Priority ≥15) | Verify: Priority ≥15 scenarios, Limits (E2E 2-5, Int 0-8, Unit 0-15, Total 10-28), Anti-Framework | Stop execution |

**kanban_board.md update:** Remove Canceled → Add new to Backlog → Preserve structure

**Step 5: Return Summary**

```
REPLAN EXECUTED for [Story ID]:

OPERATIONS SUMMARY:
✓ Kept: X tasks (no changes needed)
✓ Updated: X tasks (AC/approach changed)
✓ Canceled: X tasks (features removed)
✓ Created: X tasks (new requirements)

UPDATED TASKS:
  1. [TASK_ID: Task Title](url) - AC# added
  2. [TASK_ID: Task Title](url) - Technical approach changed

CANCELED TASKS:
  1. [TASK_ID: Task Title] - Feature removed from Story

NEW TASKS:
  1. [TASK_ID: Task Title](url) - New requirement

WARNINGS:
  - [Warning details if any]

kanban_board.md updated.

NEXT STEPS:
- Run x-story-validator to verify Story before execution (Backlog → Todo)
- Run x-story-coordinator to start task execution (Todo → In Progress)
```

---

## Critical Rules

### 1. Status Constraints

**UPDATE/OBSOLETE Operations**:
- ✅ Allowed: Todo or Backlog status ONLY
- ⚠️ Warning required: In Progress or To Review status (show warning, don't auto-update/cancel)
- ❌ Never touch: Done or Canceled status (preserve history)

**Rationale**: Protect work in progress, preserve completed work.

### 2. Preserve Done Tasks

**HARD RULE**: Never update or cancel Done tasks.

**If IDEAL conflicts with Done tasks**:
- Keep Done tasks as-is
- CREATE new task to address discrepancy (e.g., "Refactor X to use Y")
- Add comment explaining why follow-up work needed

**Example**:
```
Done: EP7_01 "Token generation with JWT"
IDEAL: "Token generation with OAuth2" (different approach!)
Action: CREATE "EP7_04: Migrate token generation to OAuth2"
```

### 3. Type-Specific Validation (Enforced in Phase 5)

**For implementation tasks:** NO test creation allowed
- Scan for: "write tests", "create tests", "add tests"
- ERROR if detected → Stop execution

**For refactoring tasks:** Regression Testing Strategy REQUIRED
- Verify: Code Quality Issues, Refactoring Plan (3 phases), Regression Strategy
- Verify: "Preserve Functionality" HARD RULE mentioned
- ERROR if missing → Stop execution

**For test tasks:** Risk-Based Testing REQUIRED
- Verify: Priority ≥15 scenarios present
- Verify: Test limits (E2E 2-5, Integration 0-8, Unit 0-15, Total 10-28)
- ERROR if Priority <15 all scenarios OR limits exceeded → Stop execution

**Same validation logic as x-task-creator Phase 2.**

### 4. Clear Diffs for Updates

**For UPDATE operations**:
- Show before/after diff for changed sections
- Highlight added/removed AC
- Show technical approach changes
- Make review easy for user

### 5. Meaningful Cancel Comments

**For OBSOLETE operations**:
- Add comment explaining why task canceled
- Reference removed AC numbers and descriptions
- Provide reason (feature removed, merged into different task, scope reduced)

**Rationale**: Preserves history, helps team understand why work was canceled.

### 6. Conservative Updates

**Best Practice**: Prefer CREATE over UPDATE when in doubt.

**Why**:
- Updating tasks can invalidate work in progress
- Creating new tasks preserves existing work
- Easier to merge tasks later than to recover lost work

### 7. Consumer-First Preserved

**This skill does NOT reorder tasks** - IDEAL plan from orchestrator already has Consumer-First ordering applied.

Replan operations preserve order:
- KEEP tasks → stay in same position
- UPDATE tasks → stay in same position
- CREATE tasks → added at end (in Consumer-First order from IDEAL)
- OBSOLETE tasks → removed (canceled)

---

## Definition of Done

Before completing work, verify ALL checkpoints:

**✅ Existing Tasks Loaded (Phase 1):**
- [ ] All existing task IDs queried from Linear
- [ ] Full descriptions fetched for all tasks
- [ ] 7 sections parsed for each task
- [ ] Metadata extracted (ID, title, status, AC, goal, estimate, guide links)

**✅ Comparison Performed (Phase 2):**
- [ ] All tasks matched by goal (IDEAL vs existing)
- [ ] Operations categorized (KEEP/UPDATE/OBSOLETE/CREATE)
- [ ] Edge cases detected (In Progress/To Review warnings, AC reassignment, etc.)
- [ ] Comparison algorithm applied correctly (see replan_algorithm.md)

**✅ Operations Summary Shown (Phase 3):**
- [ ] IDEAL plan displayed
- [ ] All existing tasks listed with operations
- [ ] Diffs shown for UPDATE operations (before/after)
- [ ] New tasks listed with details
- [ ] Operations count displayed (X keep, X update, X cancel, X create)
- [ ] Warnings shown (if any)

**✅ User Confirmed (Phase 4):**
- [ ] User typed "confirm"
- [ ] Ready to execute operations

**✅ Operations Executed (Phase 5):**
- [ ] All UPDATE operations executed (descriptions updated in Linear, comments added)
- [ ] All OBSOLETE operations executed (tasks canceled in Linear, comments added)
- [ ] All CREATE operations executed (tasks created in Linear)
- [ ] kanban_board.md updated (canceled removed, new added)
- [ ] Linear URLs captured for updated/created tasks

**✅ Type-Specific Validation Passed:**
- [ ] All UPDATE task documents validated (implementation: NO test creation, refactoring: Regression Strategy present, test: Priority ≥15 + limits)
- [ ] All CREATE task documents validated (same rules by taskType)
- [ ] Validation passed for all operations

**✅ Summary Returned (Phase 5):**
- [ ] Operations summary displayed (kept/updated/canceled/created counts)
- [ ] Updated tasks list with Linear URLs
- [ ] Canceled tasks list
- [ ] New tasks list with Linear URLs
- [ ] Warnings displayed (if any)
- [ ] kanban_board.md update confirmed
- [ ] Next steps provided

**Output**: Operations summary + Linear URLs + warnings (if any)

---

## Reference Files

### replan_algorithm.md (Worker-Specific Logic)

**Purpose**: Detailed comparison logic for REPLAN mode

**Contents**:
- KEEP/UPDATE/OBSOLETE/CREATE categorization rules
- Status constraints (Todo/In Progress/Done)
- Edge case handling (In Progress updates, AC reassignment, Done conflicts)
- Example scenarios (AC change, feature removed, new feature, scope reduction, complex reassignment)
- Best practices (conservative updates, preserve history, clear diffs)

**Location**: [x-task-replanner/references/replan_algorithm.md](references/replan_algorithm.md)

**Ownership**: x-task-replanner (worker-specific logic)

**Usage**: x-task-replanner applies this algorithm in Phase 2 (Compare IDEAL vs Existing)

### Task Templates (x-task-creator Ownership)

**This skill reads ALL 3 templates** from x-task-creator/references/ directory:

**task_template_implementation.md:**
- **Purpose**: Implementation task template (7 sections, 146 lines)
- **Location**: [x-task-creator/references/task_template_implementation.md](../x-task-creator/references/task_template_implementation.md)
- **Usage**: Read when `taskType: "implementation"` for UPDATE/CREATE operations

**refactoring_task_template.md:**
- **Purpose**: Refactoring task template (7 sections, 513 lines)
- **Location**: [x-task-creator/references/refactoring_task_template.md](../x-task-creator/references/refactoring_task_template.md)
- **Usage**: Read when `taskType: "refactoring"` for UPDATE/CREATE operations

**test_task_template.md:**
- **Purpose**: Test task template (11 sections, 542 lines)
- **Location**: [x-task-creator/references/test_task_template.md](../x-task-creator/references/test_task_template.md)
- **Usage**: Read when `taskType: "test"` for UPDATE/CREATE operations

**Ownership**: x-task-creator (universal factory owns all product templates)

**Template Selection**: Based on `taskType` parameter from orchestrator

---

## Integration with Orchestrators

**Called by 3 orchestrators when existing tasks found (count ≥ 1):**

| Orchestrator | Trigger | taskType | Extra Parameters |
|--------------|---------|----------|------------------|
| x-task-coordinator | Story AC/approach changed | implementation | idealPlan, guideLinks |
| x-story-quality-coordinator | New code quality issues | refactoring | codeQualityIssues, refactoringPlan, affectedComponents |
| x-test-coordinator | Manual test results changed | test | manualTestResults, testPlan, infra, docs, cleanup |

**Common parameters:** teamId, storyData, existingTaskIds

**Returns:** Success (operations summary + URLs + warnings) OR Error (validation failed)

**Orchestrator-Worker split:**
- **Orchestrator:** Provides taskType, team ID, story data, type-specific plan, existing task IDs (metadata only)
- **Worker (this skill):** Loads FULL descriptions → Parses sections → Compares IDEAL vs existing → Generates docs → Validates → Executes operations → Updates kanban_board.md

---

## Best Practices

### Comparison

**Match by Goal**: Fuzzy matching on titles and AC overlap (not exact title match)

**Be Conservative**: Prefer KEEP when in doubt (avoid unnecessary updates)

**Detect AC Reassignment**: Watch for AC moving between tasks (complex case requiring refactoring)

### Status Handling

**Respect Status**: Never auto-update/cancel In Progress, To Review, or Done tasks

**Show Warnings**: Clear warnings for edge cases (let user decide)

**Preserve History**: Use Canceled state (don't delete obsolete tasks)

### Diffs

**Clear Diffs**: Show before/after for UPDATE operations (focus on changed sections)

**Highlight Changes**: Use diff format (- removed, + added)

**Section-Level Diffs**: Show AC section, Implementation Plan section, Technical Approach section separately

### Linear Integration

**Atomic Operations**: Execute all UPDATE → OBSOLETE → CREATE in sequence (don't mix)

**Meaningful Comments**: Explain why updated/canceled (preserve context for team)

**URLs for Tracking**: Capture and return Linear URLs for all updated/created tasks

### kanban_board.md Updates

**Remove Canceled**: Search all sections (Backlog, Todo, In Progress) and remove

**Add New**: Only in Backlog section (new tasks start there)

**Preserve Structure**: Don't reformat, maintain Epic headers and indentation

---

**Version:** 2.2.0
**Last Updated:** 2025-11-14
