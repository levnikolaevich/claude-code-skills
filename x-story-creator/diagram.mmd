%% x-story-creator: User Story Creator
%% Creates User Stories in As a/I want/So that format
%% Single Mode (1 story) or Batch Mode (5-10 stories from Epic)

graph TD
    Start([Start: Create Story]) --> ModeDetect{Mode detection:<br/>Singular vs Plural?}

    ModeDetect -->|Singular| SingleMode[Single Mode:<br/>Create ONE Story]
    ModeDetect -->|Plural| BatchMode[Batch Mode:<br/>Create 5-10 Stories from Epic]

    %% Single Mode Path
    SingleMode --> S_Phase1[Phase 1: Discovery<br/>Team ID + Epic + Next Story Number]
    S_Phase1 --> S_Phase2[Phase 2: Planning Dialog<br/>6 questions: persona, capability,<br/>value, Epic, AC, app type]
    S_Phase2 --> PackageCheck1{Package<br/>mentioned?}
    PackageCheck1 -->|Yes| S_Validate[Phase 3: Package Validation<br/>Check version, guide exists]
    PackageCheck1 -->|No| S_Phase4
    S_Validate --> PackageOK1{Valid &<br/>guide exists?}
    PackageOK1 -->|No| BlockSingle[BLOCK: Fix package/guide first]
    PackageOK1 -->|Yes| S_Phase4
    S_Phase4[Phase 4: Generation<br/>Story with Given-When-Then AC<br/>+ Test Strategy]
    S_Phase4 --> S_Confirm{User<br/>confirms?}
    S_Confirm -->|Yes| S_Create[Phase 5: Create Linear Issue<br/>with label user-story]
    S_Confirm -->|No| S_Phase2
    S_Create --> End

    %% Batch Mode Path
    BatchMode --> B_Phase1[Phase 1: Discovery<br/>Team ID + Epic + Next Story Number]
    B_Phase1 --> B_Phase2[Phase 2: Epic Analysis<br/>Identify 5-10 stories]
    B_Phase2 --> PackageCheck2{Packages<br/>mentioned?}
    PackageCheck2 -->|Yes| B_Validate[Phase 3: Package Validation<br/>Check all packages]
    PackageCheck2 -->|No| B_Phase4
    B_Validate --> PackageOK2{All valid &<br/>guides exist?}
    PackageOK2 -->|No| BlockBatch[BLOCK: Fix packages/guides first]
    PackageOK2 -->|Yes| B_Phase4
    B_Phase4[Phase 4: Batch Generation<br/>5-10 Stories with AC]
    B_Phase4 --> B_Confirm{User<br/>confirms?}
    B_Confirm -->|Yes| B_Create[Phase 5: Batch Create<br/>Linear Issues]
    B_Confirm -->|No| B_Phase2
    B_Create --> End

    BlockSingle --> End([End])
    BlockBatch --> End

    %% Styling
    classDef discovery fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef dialog fill:#FFF9C4,stroke:#F57C00,stroke-width:2px
    classDef decision fill:#FFE0B2,stroke:#E64A19,stroke-width:2px
    classDef action fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    classDef error fill:#FFCDD2,stroke:#C62828,stroke-width:2px

    class S_Phase1,B_Phase1,B_Phase2 discovery
    class S_Phase2,S_Validate,B_Validate,S_Phase4,B_Phase4 dialog
    class ModeDetect,PackageCheck1,PackageCheck2,PackageOK1,PackageOK2,S_Confirm,B_Confirm decision
    class S_Create,B_Create action
    class BlockSingle,BlockBatch error
